name: CI - Deploy helm on Registry
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
jobs:
  pipeline-steps-spring-boot-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.3.1
      - name: Prepare Dirs
        run: |
          mkdir ./artifacts
      - name: Package Helm chart - spring-boot-app
        run: |
          SBA_CHART_VERSION=$(yq '.version' ./spring-boot-app/Chart.yaml)
          SBA_CHART_NAME=$(yq '.name' ./spring-boot-app/Chart.yaml)
          echo [DEPLOY spring-boot-app] [CHART=$SBA_CHART_VERSION] [VERSION=$SBA_CHART_VERSION]
          helm dependency update ./spring-boot-app
          helm lint ./spring-boot-app
          helm package ./spring-boot-app --destination ./artifacts
          curl -u ${{ secrets.HELM_USER }}:${{ secrets.HELM_TOKEN }} https://nxr.starlord443.dev/repository/helm-local/ --upload-file ./artifacts/${SBA_CHART_NAME}-${SBA_CHART_VERSION}.tgz -v
